$('.prestashop-page').live('pageshow',function(event){if($('#stores_search_block .ui-btn').length){$('#stores_search_block .ui-btn').live('click',function(){searchStores()})}});function searchStores(){var pattern=$('#location').val();var radius=$('#radius').val();if(pattern!=''&&radius>0&&radius<=100){var geocoder=new google.maps.Geocoder();geocoder.geocode({address:pattern},function(res,code){if(code==google.maps.GeocoderStatus.OK)getStores(res[0].geometry.location,radius)})}else if($('.stores_block').is(':visible'))$('.stores_block').hide()}function getStores(coordinates,radius){var latitude=coordinates.lat();var longitude=coordinates.lng();if(latitude!=undefined&&latitude!=undefined&&radius!=undefined){$.ajax({type:'POST',headers:{"cache-control":"no-cache"},url:'index.php?controller=stores'+'&rand='+new Date().getTime(),data:'ajax=true&latitude='+latitude+'&longitude='+longitude+'&radius='+radius,dataType:'json',async:true,success:function(data){var list=$('#stores_list');if(data.length==0)list.hide();else{list.html('');$.each(data,function(index,element){var store_address='';store_address+=element.address1+(element.address2!=null?element.address2:' ')+', ';store_address+=element.city+', '+element.postcode+(element.state!=null?' '+element.state:'')+', '+element.country;list.append($('<li>'+'<a href="http://maps.google.com/maps?q='+encodeURI(store_address)+'">'+'<img src="'+img_store_dir+parseInt(element.picture)+'.jpg" width="80"/>'+'<h3>'+element.name+' ('+Math.floor(element.distance)+distance_unit+')</h3>'+'<p>'+store_address+'</p>'+'</a>'+'</li>'))});list.parent().show();list.listview('refresh');$('html, body').animate({scrollTop:list.parent().offset().top},'slow')}},error:function(XMLHttpRequest,status){}})}}